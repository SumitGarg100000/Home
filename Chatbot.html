<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23007bff%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><polygon points=%2212 2 2 7 12 12 22 7 12 2%22/><polyline points=%222 17 12 22 22 17%22/><polyline points=%222 12 12 17 22 12%22/></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tax Dost - Your AI Tax Assistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'primary': '#007bff',
              'primary-dark': '#0056b3',
              'secondary': '#0d9488',
              'background': '#f1f5f9',
              'surface': '#ffffff',
              'text-primary': '#1e293b',
              'text-secondary': '#475569',
            },
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            keyframes: {
              'fade-in': {
                '0%': { opacity: '0', transform: 'translateY(10px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              },
            },
            animation: {
              'fade-in': 'fade-in 0.5s ease-out forwards',
            }
          }
        }
      }
    </script>
    <style>
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1; /* slate-300 */
        border-radius: 20px;
        border: 3px solid transparent;
      }
       .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background-color: #94a3b8; /* slate-400 */
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.1.1",
    "react-dom/client": "https://aistudiocdn.com/react-dom@^19.1.1/client",
    "react/": "https://aistudiocdn.com/react@^19.1.1/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.16.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/"
  }
}
</script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<link rel="stylesheet" href="/index.css">
</head>
  <body class="bg-slate-200">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useCallback, useRef, useMemo } from 'react';
      import ReactDOM from 'react-dom/client';
      import { GoogleGenAI } from "@google/genai";

      // --- TYPES ---
      interface Source {
        uri: string;
        title: string;
      }

      interface FileInfo {
        name: string;
        type: string;
        size: number;
      }

      interface Message {
        id: number;
        role: 'user' | 'model';
        text: string;
        sources: Source[];
        image?: string; // data URL for the image preview
        fileInfo?: FileInfo;
        base64Data?: string; // Store base64 for re-submission on edit
        isError?: boolean;
      }

      // --- CONSTANTS ---
      const SYSTEM_INSTRUCTION = `
      You are "Tax Dost," an AI assistant with world-class expertise in Indian tax law, coding, and a vast range of other professional fields. Your function is to provide comprehensive, accurate, and brilliantly presented answers.

      **Identity Rules: THIS IS THE MOST IMPORTANT INSTRUCTION.**
      - Your primary and ONLY identity is "Tax Dost".
      - You MUST NOT mention that you can code or have any programming abilities unless a user explicitly asks you a coding-related question.
      - If asked who created you, who your developer is, or who made you, you MUST respond that you were created by "Sumit Garg". You should state that all your training was done by Sumit Garg. **DO NOT mention Google or any other company.** This is a strict rule.

      **Core Answering Methodology (The Chartered Accountant's Mindset):**

      Your thinking process for every query, especially tax-related ones, MUST follow these steps to emulate a professional Chartered Accountant:

      1.  **Deconstruct the Query & Identify Core Concepts**:
          - Break down the user's question into its fundamental legal concepts. For example, a query about "audit not required for profits less than 8%" contains the concepts of "Tax Audit" (Section 44AB) and "Presumptive Income" (Section 44AD). You must identify ALL relevant sections, even if the user only names one.

      2.  **Scenario Analysis Based on Thresholds**:
          - Identify every numerical limit and threshold mentioned in the relevant sections (e.g., turnover limits of â‚¹1 crore, â‚¹2 crore, â‚¹3 crore, â‚¹10 crore; receipt limits; profit percentages).
          - Systematically create and analyze every possible scenario based on these thresholds. For a turnover-related query, your analysis must cover:
              - Turnover below Limit 1 (e.g., < 1 Cr)
              - Turnover between Limit 1 and 2 (e.g., 1 Cr to 2 Cr)
              - Turnover between Limit 2 and 3 (e.g., 2 Cr to 3 Cr)
              - Turnover above the highest limit (e.g., > 3 Cr)
          - For each scenario, explain the exact legal implications, requirements, and consequences.

      3.  **Analyze the Interplay of Sections**:
          - This is the MOST CRITICAL step. Do not analyze sections in isolation.
          - Explain how different sections interact, override, or complement each other. For instance, explain how choosing Section 44AD impacts the applicability of Section 44AB (Tax Audit) and Section 44AA (Book Keeping). Explain how an exception in one section might be restricted by a condition in another.

      4.  **Address Ambiguity and Debatable Points**:
          - Many areas of tax law have common confusions or are subject to debate (e.g., "can ITR-1 be filed for two salaries?").
          - You MUST identify these ambiguities.
          - Present the common interpretation and then contrast it with the strict legal rule or official CBDT/departmental clarification.
          - Clearly state the risks of taking the commonly-followed (but potentially incorrect) path.
          - Conclude with a recommendation for the safest, most compliant course of action.

      5.  **Presentation Excellence & Research**:
          - Use your search tool to find the absolute latest information, circulars, and notifications from official sources (incometaxindia.gov.in, cbic.gov.in).
          - Your answers must be attractive and easy to read. Use formatting elements like bullet points, numbered lists, headings, and bold text strategically to break down complex information and highlight key points. Use Markdown tables for data-heavy content.

      **CRITICAL: Structure your response using the following format and tags. DO NOT write anything outside of these tags. Do not use markdown like \`\`\`json.**

      [ANSWER]
      Start with the direct, highlighted answer by enclosing it in **double asterisks**. Then, provide a detailed, comprehensive explanation covering all scenarios you identified in your analysis.
      [/ANSWER]

      [CODE]
      If the user requests code, provide the complete, runnable, and self-reviewed code snippet in this section. Start the code with triple backticks and the language name (e.g., \`\`\`python, \`\`\`javascript). End it with triple backticks.
      [/CODE]

      [BARE_ACT]
      (For tax queries only) Quote or paraphrase the relevant legal text from the actual law (the "Bare Act") in this section.
      [/BARE_ACT]

      [EXAMPLES]
      Provide multiple, comprehensive examples that cover every different scenario you explained in the [ANSWER] section.
      [/EXAMPLES]

      [CONCLUSION]
      Summarize the entire response and give a final, clear, to-the-point takeaway for the user.
      [/CONCLUSION]

      **General Rules:**
      - **Conditional Sections**: The \`[ANSWER]\` section is mandatory. OMIT THE ENTIRE TAG BLOCK for any other section if it is not applicable. For simple conversational queries (like "hi", "how are you?"), do not include tags and just provide a friendly response.
      - **Directness**: No formal introductions or greetings. Jump straight to the answer.
      - **Source Links**: After the [CONCLUSION] tag, list official source links under "**Sources**" if you used them.
      - **Context**: Use the entire conversation history for follow-up questions.
      - **Response Length & Language**: The user will specify a desired response length (Short, Medium, or Detailed) and language (e.g., Hinglish, English) at the beginning of their prompt. Adhere strictly to this instruction.
      `;

      // --- GEMINI SERVICE ---
      const initializeGemini = () => {
          try {
              const ai = new GoogleGenAI({ apiKey:"AIzaSyDGYcOlkOD_XT7ZLj_GZu6xUu59hXCxEP8"});
              return ai;
          } catch (error) {
              console.error("Error initializing Gemini:", error);
              throw new Error("Could not initialize Gemini. Check your API key and configuration.");
          }
      };

      const modelConfig = {
          systemInstruction: SYSTEM_INSTRUCTION,
          tools: [{ googleSearch: {} }],
      };

      // --- ICONS ---
      const EagleIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <polygon points="12 2 2 7 12 12 22 7 12 2"/>
            <polyline points="2 17 12 22 22 17"/>
            <polyline points="2 12 12 17 22 12"/>
          </svg>
      );
      const UserIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      );
      const SendIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
              <line x1="22" y1="2" x2="11" y2="13" />
              <polygon points="22 2 15 22 11 13 2 9 22 2" />
          </svg>
      );
      const PlusIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
          </svg>
      );
      const PaperclipIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
      );
      const XIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      );
      const CopyIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
      );
      const CheckIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"></polyline></svg>
      );
      const EditIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></svg>
      );
      const AnswerIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>
      );
      const BareActIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
      );
      const ExamplesIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      );
      const ConclusionIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="m10.5 16.5 2 2 4-4"/></svg>
      );
      const LinkIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
      );
      const CodeIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
      );

      // --- COMPONENTS ---
      const LanguageSelector = ({ selectedLanguage, onLanguageChange }) => (
          <div className="relative inline-block text-left">
              <div className="group">
                   <label htmlFor="language-select" className="sr-only">Select language</label>
                  <select
                      id="language-select"
                      value={selectedLanguage}
                      onChange={(e) => onLanguageChange(e.target.value)}
                      className="appearance-none bg-white/25 text-white text-sm font-medium py-1.5 pl-3 pr-8 rounded-md focus:outline-none focus:ring-2 focus:ring-white/50 transition-colors"
                      aria-label="Select response language"
                  >
                      <option className="text-black" value="Hinglish">Hinglish</option>
                      <option className="text-black" value="English">English</option>
                      <option className="text-black" value="Hindi">Hindi</option>
                  </select>
                  <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-white">
                      <svg className="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                  </div>
              </div>
          </div>
      );
      
      const ResponseLengthSelector = ({ selectedLength, onLengthChange }) => (
          <div className="relative inline-block text-left">
              <div className="group">
                   <label htmlFor="length-select" className="sr-only">Select response length</label>
                  <select
                      id="length-select"
                      value={selectedLength}
                      onChange={(e) => onLengthChange(e.target.value)}
                      className="appearance-none bg-white/25 text-white text-sm font-medium py-1.5 pl-3 pr-8 rounded-md focus:outline-none focus:ring-2 focus:ring-white/50 transition-colors"
                      aria-label="Select response length"
                  >
                      <option className="text-black" value="Short">Short</option>
                      <option className="text-black" value="Medium">Medium</option>
                      <option className="text-black" value="Detailed">Detailed</option>
                  </select>
                  <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-white">
                      <svg className="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                  </div>
              </div>
          </div>
      );

      const Header = ({ language, onLanguageChange, responseLength, onResponseLengthChange }) => (
        <header className="bg-primary w-full z-10 sticky top-0 shadow-md flex-shrink-0">
          <div className="max-w-4xl mx-auto p-3 px-4 flex items-center justify-between">
             <div className="flex items-center space-x-3">
                <h1 className="text-xl font-bold text-white tracking-tight">
                Tax Dost ðŸ¤–
                </h1>
            </div>
            <div className="flex items-center space-x-3">
              <ResponseLengthSelector selectedLength={responseLength} onLengthChange={onResponseLengthChange} />
              <LanguageSelector selectedLanguage={language} onLanguageChange={onLanguageChange} />
            </div>
          </div>
        </header>
      );

      const useCopyToClipboard = (text) => {
          const [isCopied, setIsCopied] = useState(false);
          const handleCopy = useCallback(async () => {
              if (navigator.clipboard && text) {
                  await navigator.clipboard.writeText(text);
                  setIsCopied(true);
                  setTimeout(() => setIsCopied(false), 2000);
              }
          }, [text]);
          return { isCopied, handleCopy };
      };

      const SimpleMarkdown = ({ text, isParagraph = false }) => {
          const parts = text.split(/(\*\*.*?\*\*)/g);
          const content = (
              <React.Fragment>
                  {parts.map((part, i) => {
                      if (part.startsWith('**') && part.endsWith('**')) {
                          return <strong key={i} className="font-bold text-primary-dark">{part.slice(2, -2)}</strong>;
                      }
                      return part;
                  })}
              </React.Fragment>
          );
          return isParagraph ? <p className="my-2 whitespace-pre-wrap">{content}</p> : content;
      };

      const MarkdownRenderer = ({ text }) => {
        const blocks = text.split(/\n\s*\n/); 
        return (
          <React.Fragment>
            {blocks.map((block, index) => {
              const trimmedBlock = block.trim();
              const lines = trimmedBlock.split('\n');
              const isTable = lines.length > 1 && lines.every(line => line.trim().startsWith('|') && line.trim().endsWith('|')) && lines[1].includes('---');
              
              if (isTable) {
                  try {
                      const headerLine = lines[0];
                      const bodyLines = lines.slice(2);
                      const headers = headerLine.split('|').map(h => h.trim()).filter(Boolean);
                      const rows = bodyLines.map(rowLine => rowLine.split('|').map(c => c.trim()).filter(Boolean));
                      return (
                          <div key={index} className="overflow-x-auto my-4 border border-slate-200 rounded-lg shadow-sm">
                          <table className="min-w-full divide-y divide-slate-200">
                              <thead className="bg-slate-50">
                              <tr>{headers.map((header, i) => <th key={i} className="px-4 py-2 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">{header}</th>)}</tr>
                              </thead>
                              <tbody className="bg-white divide-y divide-slate-200">
                              {rows.map((row, i) => <tr key={i}>{row.map((cell, j) => <td key={j} className="px-4 py-3 text-sm text-slate-700 leading-relaxed"><SimpleMarkdown text={cell} /></td>)}</tr>)}
                              </tbody>
                          </table>
                          </div>
                      );
                  } catch (e) {
                       return <SimpleMarkdown key={index} text={trimmedBlock} isParagraph={true} />;
                  }
              } else {
                return <SimpleMarkdown key={index} text={trimmedBlock} isParagraph={true} />;
              }
            })}
          </React.Fragment>
        );
      };

      const CodeBlock = ({ content }) => {
          const codeBlockRegex = /^```(\w*)\n([\s\S]*?)```$/m;
          const match = content.match(codeBlockRegex);
          const language = match && match[1] ? match[1] : 'code';
          const code = match ? match[2].trim() : content.trim();
          const { isCopied, handleCopy } = useCopyToClipboard(code);
          return (
              <div className="bg-slate-800 text-sm rounded-xl shadow-lg mt-4 overflow-hidden border border-slate-700">
                  <header className="flex items-center justify-between p-3 bg-slate-900/70 border-b border-slate-700">
                      <div className="flex items-center gap-2">
                          <span className="text-xs font-semibold text-slate-400 uppercase tracking-wider">{language}</span>
                      </div>
                      <button
                          onClick={handleCopy}
                          className="flex items-center gap-1.5 text-xs font-medium px-2 py-1 rounded-md bg-slate-700 text-slate-300 hover:bg-slate-600 transition-colors"
                          aria-label="Copy code"
                      >
                          {isCopied ? <CheckIcon className="w-3.5 h-3.5 text-green-400"/> : <CopyIcon className="w-3.5 h-3.5" />}
                          {isCopied ? 'Copied!' : 'Copy code'}
                      </button>
                  </header>
                  <div className="p-4 text-sm leading-relaxed overflow-x-auto custom-scrollbar">
                      <pre><code className={`language-${language} text-slate-200 font-mono text-[13px]`}>{code}</code></pre>
                  </div>
              </div>
          );
      };

      const SectionCard = ({ title, icon, content, variant = 'default' }) => {
          const { isCopied, handleCopy } = useCopyToClipboard(content);
          if (!content || !content.trim()) return null;
          const cardStyles = {
              'default': { bg: 'bg-surface', headerBg: 'bg-slate-50/70', border: 'border-slate-200/80', contentClasses: 'text-text-secondary' },
              'bare-act': { bg: 'bg-slate-50', headerBg: 'bg-slate-100', border: 'border-slate-200', contentClasses: 'font-mono text-slate-700 text-[13px]' }
          };
          const styles = cardStyles[variant];
          return (
              <div className={`${styles.bg} rounded-xl shadow-sm border ${styles.border} mt-4 overflow-hidden`}>
                  <header className={`flex items-center justify-between p-3 ${styles.headerBg} border-b ${styles.border}`}>
                      <div className="flex items-center gap-2">
                          {icon}
                          <h3 className="text-sm font-semibold text-text-primary">{title}</h3>
                      </div>
                      <button
                          onClick={handleCopy}
                          className="flex items-center gap-1.5 text-xs font-medium px-2 py-1 rounded-md bg-slate-200/70 text-slate-600 hover:bg-slate-300 transition-colors"
                          aria-label={`Copy ${title}`}
                      >
                          {isCopied ? <CheckIcon className="w-3.5 h-3.5 text-green-600"/> : <CopyIcon className="w-3.5 h-3.5" />}
                          {isCopied ? 'Copied!' : 'Copy'}
                      </button>
                  </header>
                  <div className={`p-4 text-sm leading-relaxed prose prose-sm max-w-none ${styles.contentClasses}`}>
                      <MarkdownRenderer text={content} />
                  </div>
              </div>
          );
      };

      const StructuredResponse = ({ text, sources }) => {
          const parsedSections = useMemo(() => {
              const sections = {};
              const sectionRegex = /\[(ANSWER|CODE|BARE_ACT|EXAMPLES|CONCLUSION)\]([\s\S]*?)\[\/\1\]/g;
              let match;
              while ((match = sectionRegex.exec(text)) !== null) {
                  sections[match[1]] = match[2].trim();
              }
              return sections;
          }, [text]);

          const sectionConfig = [
              { key: 'ANSWER', title: 'Answer', icon: <AnswerIcon className="w-4 h-4 text-primary" />, type: 'card', variant: 'default' },
              { key: 'CODE', title: 'Code', icon: <CodeIcon className="w-4 h-4 text-purple-500" />, type: 'code' },
              { key: 'BARE_ACT', title: 'Bare Act', icon: <BareActIcon className="w-4 h-4 text-blue-800" />, type: 'card', variant: 'bare-act' },
              { key: 'EXAMPLES', title: 'Examples', icon: <ExamplesIcon className="w-4 h-4 text-amber-600" />, type: 'card', variant: 'default' },
              { key: 'CONCLUSION', title: 'Conclusion', icon: <ConclusionIcon className="w-4 h-4 text-secondary" />, type: 'card', variant: 'default' },
          ];

          if (Object.keys(parsedSections).length === 0) {
              return (
                  <div className="bg-white rounded-xl rounded-tl-none shadow-sm border border-slate-200/80 p-4">
                       <div className="prose prose-sm max-w-none text-text-primary">
                          <p className="whitespace-pre-wrap">{text}</p>
                       </div>
                  </div>
              );
          }

          return (
              <div>
                  {sectionConfig.map(section => {
                      const content = parsedSections[section.key];
                      if (!content) return null;
                      if (section.type === 'code') {
                          return <CodeBlock key={section.key} content={content} />;
                      }
                      return (
                          <SectionCard key={section.key} title={section.title} icon={section.icon} content={content} variant={section.variant} />
                      );
                  })}
                   {sources && sources.length > 0 && (
                       <div className="mt-6 pt-4 border-t border-slate-200">
                          <h4 className="text-sm font-semibold text-slate-800 mb-3 flex items-center gap-2">
                              <LinkIcon className="w-4 h-4 text-slate-500" />
                              Sources
                          </h4>
                          <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                          {sources.map((source, index) => (
                              <a 
                                  key={index} 
                                  href={source.uri} 
                                  target="_blank" 
                                  rel="noopener noreferrer" 
                                  className="group bg-white border border-slate-200 hover:border-primary/50 hover:bg-primary/5 transition-all duration-200 rounded-lg p-3 flex items-start gap-3 truncate shadow-sm"
                                  title={source.title}
                              >
                                  <div className="flex-shrink-0 w-8 h-8 rounded-full bg-slate-100 group-hover:bg-primary/10 flex items-center justify-center transition-colors">
                                      <LinkIcon className="w-4 h-4 text-slate-500 group-hover:text-primary transition-colors" />
                                  </div>
                                  <div className="flex-1 overflow-hidden">
                                      <p className="text-sm font-medium text-slate-800 truncate group-hover:text-primary-dark">{source.title}</p>
                                      <p className="text-xs text-slate-500 truncate">{source.uri}</p>
                                  </div>
                              </a>
                          ))}
                          </div>
                      </div>
                  )}
              </div>
          );
      };

      const MessageComponent = ({ message, onEditMessage }) => {
        const isUser = message.role === 'user';
        const [isEditing, setIsEditing] = useState(false);
        const [editedText, setEditedText] = useState(message.text);
        const textareaRef = useRef(null);
      
        useEffect(() => {
            if (isEditing && textareaRef.current) {
                textareaRef.current.style.height = 'auto';
                textareaRef.current.style.height = `${textareaRef.current.scrollHeight}px`;
                textareaRef.current.focus();
            }
        }, [isEditing, editedText]);
      
        const handleSave = () => {
            if (editedText.trim() && editedText.trim() !== message.text) {
                onEditMessage(message.id, editedText.trim());
            }
            setIsEditing(false);
        };
      
        const handleCancel = () => {
            setEditedText(message.text);
            setIsEditing(false);
        };

        const handleKeyDown = (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              handleSave();
          }
          if (e.key === 'Escape') {
              e.preventDefault();
              handleCancel();
          }
        };

        if (isUser) {
          return (
            <div className="flex items-start gap-3 justify-end group">
              <div className="bg-primary text-white rounded-xl rounded-tr-none px-4 py-3 max-w-2xl shadow-md relative">
                 {isEditing ? (
                   <div className="flex flex-col gap-2 w-full min-w-64">
                       <textarea
                           ref={textareaRef}
                           value={editedText}
                           onChange={(e) => setEditedText(e.target.value)}
                           onKeyDown={handleKeyDown}
                           className="bg-blue-700 text-white rounded-md p-2 w-full focus:outline-none focus:ring-2 focus:ring-white/50 resize-none text-base font-sans"
                           rows="1"
                           aria-label="Edit message content"
                       />
                       <div className="flex items-center justify-end gap-2">
                           <button onClick={handleCancel} className="text-xs font-semibold px-3 py-1 rounded hover:bg-white/10 transition-colors">Cancel</button>
                           <button onClick={handleSave} className="text-xs font-semibold px-3 py-1 rounded bg-white text-primary hover:bg-slate-200 transition-colors">Save</button>
                       </div>
                   </div>
                ) : (
                  <React.Fragment>
                    {message.image && ( <img src={message.image} alt="User upload" className="rounded-lg mb-2 max-w-full h-auto max-h-48 object-contain" /> )}
                    {message.fileInfo && !message.image && (
                       <div className="flex items-center gap-3 bg-blue-600 border border-blue-500 rounded-lg p-2.5 mb-2">
                          <div className="flex-shrink-0"><PaperclipIcon className="w-5 h-5 text-blue-100" /></div>
                          <div className="flex-1 text-sm text-blue-50 truncate" title={message.fileInfo.name}>
                              <p className="font-medium truncate">{message.fileInfo.name}</p>
                              <p className="text-xs text-blue-200">{message.fileInfo.type}</p>
                          </div>
                      </div>
                    )}
                    {message.text && <p className="text-base whitespace-pre-wrap">{message.text}</p>}
                    <button
                        onClick={() => setIsEditing(true)}
                        className="absolute -left-10 top-1/2 -translate-y-1/2 p-1.5 rounded-full bg-slate-200 text-slate-600 opacity-0 group-hover:opacity-100 transition-opacity focus:opacity-100 focus:outline-none focus:ring-2 focus:ring-primary/50"
                        aria-label="Edit message"
                    >
                        <EditIcon className="w-4 h-4" />
                    </button>
                  </React.Fragment>
                )}
              </div>
              <div className="w-10 h-10 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center border-2 border-white shadow-sm">
                  <UserIcon className="w-5 h-5 text-slate-600" />
              </div>
            </div>
          );
        }

        return (
          <div className="flex items-start gap-3 group">
             <div className="w-10 h-10 rounded-full bg-secondary/20 flex-shrink-0 flex items-center justify-center border-2 border-white shadow-sm">
                  <EagleIcon className="w-5 h-5 text-secondary" />
              </div>
            <div className="flex-1 max-w-2xl">
              {message.isError ? (
                 <div className="bg-red-50 text-red-800 rounded-xl rounded-tl-none border border-red-200 px-4 py-3">{message.text}</div>
              ) : (
                <StructuredResponse text={message.text} sources={message.sources} />
              )}
            </div>
          </div>
        );
      };

      const TypingIndicator = () => (
          <div className="flex items-start gap-3 animate-fade-in">
              <div className="w-10 h-10 rounded-full bg-secondary/20 flex-shrink-0 flex items-center justify-center border-2 border-white shadow-sm">
                  <EagleIcon className="w-5 h-5 text-secondary" />
              </div>
            <div className="bg-surface text-text-primary rounded-xl rounded-tl-none px-4 py-3 shadow-sm border border-slate-200">
              <div className="flex items-center space-x-1.5">
                <div className="w-2 h-2 bg-slate-400 rounded-full animate-pulse [animation-delay:-0.3s]"></div>
                <div className="w-2 h-2 bg-slate-400 rounded-full animate-pulse [animation-delay:-0.15s]"></div>
                <div className="w-2 h-2 bg-slate-400 rounded-full animate-pulse"></div>
              </div>
            </div>
          </div>
      );

      const ChatWindow = ({ messages, onEditMessage }) => {
        const messagesEndRef = useRef(null);
        
        useEffect(() => {
          messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
        }, [messages]);

        const lastMessage = messages[messages.length - 1];
        const isModelReplying = lastMessage?.role === 'model' && lastMessage?.text === '';

        return (
          <div className="space-y-6">
            {messages.map((msg) => (
              <div key={msg.id} className="animate-fade-in">
                 <MessageComponent message={msg} onEditMessage={onEditMessage} />
              </div>
            ))}
            {isModelReplying && <TypingIndicator />}
            <div ref={messagesEndRef} />
          </div>
        );
      };

      const ChatInput = ({ onSendMessage, isLoading }) => {
        const [inputValue, setInputValue] = useState('');
        const [file, setFile] = useState(null);
        const fileInputRef = useRef(null);
        const isImage = useMemo(() => file && file.type.startsWith('image/'), [file]);
        const filePreviewUrl = useMemo(() => file ? URL.createObjectURL(file) : null, [file]);
        
        const handleFileChange = (e) => {
          const selectedFile = e.target.files?.[0];
          if (selectedFile) {
            setFile(selectedFile);
          }
        };

        const removeFile = () => {
          setFile(null);
          if (fileInputRef.current) {
            fileInputRef.current.value = '';
          }
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          if ((inputValue.trim() || file) && !isLoading) {
            onSendMessage(inputValue, file);
            setInputValue('');
            removeFile();
          }
        };

        useEffect(() => {
          return () => {
            if (filePreviewUrl) {
              URL.revokeObjectURL(filePreviewUrl);
            }
          };
        }, [filePreviewUrl]);

        return (
          <div>
              {file && filePreviewUrl && (
                  <div className="p-2 relative">
                      <div className="flex items-center gap-3 bg-slate-100 border border-slate-200 rounded-lg p-2">
                          {isImage ? (
                             <img src={filePreviewUrl} alt="Preview" className="w-12 h-12 rounded-md object-cover"/>
                          ) : (
                             <div className="w-12 h-12 flex items-center justify-center bg-slate-200 rounded-md flex-shrink-0">
                                <PaperclipIcon className="w-6 h-6 text-slate-500" />
                             </div>
                          )}
                          <div className="flex-1 text-sm text-slate-700 truncate" title={file.name}>
                              <p className="font-medium truncate">{file.name}</p>
                              <p className="text-xs text-slate-500">{((file.size || 0) / 1024).toFixed(2)} KB</p>
                          </div>
                          <button type="button" onClick={removeFile} className="w-7 h-7 flex items-center justify-center rounded-full bg-slate-200 hover:bg-slate-300 transition-colors" aria-label="Remove file">
                              <XIcon className="w-4 h-4 text-slate-600" />
                          </button>
                      </div>
                  </div>
              )}
              <form onSubmit={handleSubmit} className="flex items-center space-x-3 p-2">
                  <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*,.pdf,.doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,.txt,text/plain" className="hidden" aria-hidden="true" />
                  <button type="button" onClick={() => fileInputRef.current?.click()} disabled={isLoading} className="w-11 h-11 flex-shrink-0 flex items-center justify-center rounded-full bg-slate-200 text-slate-600 hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-primary/50 disabled:opacity-50 transition-colors" aria-label="Attach file">
                      <PlusIcon className="w-5 h-5" />
                  </button>
                  <input type="text" value={inputValue} onChange={(e) => setInputValue(e.target.value)} placeholder="Yahan apna sawaal likhein..." className="flex-1 bg-slate-100 border-slate-300 rounded-full px-4 py-2.5 text-text-primary placeholder-text-secondary focus:outline-none focus:ring-2 focus:ring-primary/50 disabled:opacity-50" disabled={isLoading} aria-label="Chat input" />
                  <button type="submit" disabled={isLoading || (!inputValue.trim() && !file)} className="w-11 h-11 flex-shrink-0 flex items-center justify-center rounded-full bg-primary text-white hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary/50 disabled:bg-slate-400 disabled:cursor-not-allowed transition-all transform hover:scale-105" aria-label="Send message">
                      <SendIcon className="w-5 h-5" />
                  </button>
              </form>
          </div>
        );
      };

      // --- MAIN APP ---
      const initialMessage = {
        id: 0,
        role: 'model',
        text: "Namaste! Main aapka AI Tax Advisor 'Tax Dost' hoon. Tax se juda apna sawaal puchiye, ya koi image upload karke uske baare mein jaaniye.",
        sources: [],
      };
      
      const fileToBase64 = (file) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => {
            const result = reader.result;
            resolve(result.split(',')[1]);
          };
          reader.onerror = (error) => reject(error);
        });
      };

      const App = () => {
        const [ai, setAi] = useState(null);
        const [messages, setMessages] = useState([initialMessage]);
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState(null);
        const [language, setLanguage] = useState('Hinglish');
        const [responseLength, setResponseLength] = useState('Medium');
        
        useEffect(() => {
          try {
            const geminiAi = initializeGemini();
            setAi(geminiAi);
          } catch (e) {
            console.error("Failed to initialize Gemini:", e);
            setError("Could not initialize the AI service. Please ensure the API key is correctly configured.");
          }
        }, []);
        
        const runQuery = useCallback(async (currentMessageHistory) => {
            if (!ai) {
                setError("AI Service is not initialized.");
                return;
            }
            setIsLoading(true);
            setError(null);

            const historyForApi = currentMessageHistory.filter(m => m.id !== 0);
            const lastUserMessage = [...historyForApi].reverse().find(m => m.role === 'user');

            if (!lastUserMessage) {
                setIsLoading(false);
                return;
            }

            setMessages(prev => [...prev, { id: Date.now() + 1, role: 'model', text: '', sources: [] }]);
            const prompt = `Provide a ${responseLength} answer in ${language}. Here is the user's query: ${lastUserMessage.text}`;

            try {
                const conversationHistory = historyForApi
                    .filter(m => m.id !== lastUserMessage.id)
                    .map(m => {
                        const parts = [];
                        if (m.base64Data && m.fileInfo) {
                            parts.push({ inlineData: { mimeType: m.fileInfo.type, data: m.base64Data } });
                        }
                        if (m.text) {
                            parts.push({ text: m.text });
                        }
                        return { role: m.role, parts };
                    });

                const lastUserMessageParts = [];
                if (lastUserMessage.base64Data && lastUserMessage.fileInfo) {
                    lastUserMessageParts.push({ inlineData: { mimeType: lastUserMessage.fileInfo.type, data: lastUserMessage.base64Data } });
                }
                lastUserMessageParts.push({ text: prompt });
                
                const contents = [...conversationHistory, { role: 'user', parts: lastUserMessageParts }];

                const stream = await ai.models.generateContentStream({
                    model: 'gemini-2.5-flash',
                    contents,
                    config: modelConfig,
                });

                let fullText = '';
                let finalResponse = null;

                for await (const chunk of stream) {
                    fullText += chunk.text;
                    finalResponse = chunk;
                    setMessages(prev => {
                        const newMessages = [...prev];
                        if (newMessages.length > 0 && newMessages[newMessages.length - 1].role === 'model') {
                            newMessages[newMessages.length - 1].text = fullText;
                        }
                        return newMessages;
                    });
                }

                const sources = finalResponse?.candidates?.[0]?.groundingMetadata?.groundingChunks
                    ?.map((chunk) => ({ title: chunk.web?.title || 'Source', uri: chunk.web?.uri || '#' }))
                    .filter((source) => source.uri !== '#') || [];

                setMessages(prev => {
                    const newMessages = [...prev];
                     if (newMessages.length > 0 && newMessages[newMessages.length - 1].role === 'model') {
                        newMessages[newMessages.length - 1].sources = sources;
                     }
                    return newMessages;
                });

            } catch (e) {
                console.error("Error sending message:", e);
                const errorMessage = "Oops! Something went wrong. It might be an issue with your API key or network. Please try again.";
                setError(errorMessage);
                setMessages(prev => {
                    const newMessages = [...prev];
                    if (newMessages.length > 0 && newMessages[newMessages.length - 1].role === 'model') {
                        newMessages[newMessages.length - 1].text = errorMessage;
                        newMessages[newMessages.length - 1].isError = true;
                    }
                    return newMessages;
                });
            } finally {
                setIsLoading(false);
            }
        }, [ai, language, responseLength]);


        const handleSendMessage = useCallback(async (inputText, file) => {
            if ((!inputText.trim() && !file) || isLoading) return;

            const userMessage = { id: Date.now(), role: 'user', text: inputText, sources: [] };

            if (file) {
                const base64Data = await fileToBase64(file);
                userMessage.base64Data = base64Data;
                if (file.type.startsWith('image/')) {
                    userMessage.image = URL.createObjectURL(file);
                }
                userMessage.fileInfo = { name: file.name, type: file.type, size: file.size };
            }

            const newMessages = [...messages, userMessage];
            setMessages(newMessages);
            await runQuery(newMessages);
        }, [messages, isLoading, runQuery]);

        const handleEditMessage = useCallback(async (messageId, newText) => {
            const messageIndex = messages.findIndex(m => m.id === messageId);
            if (messageIndex === -1) return;

            const updatedMessage = { ...messages[messageIndex], text: newText };
            const newMessages = [...messages.slice(0, messageIndex), updatedMessage];

            setMessages(newMessages);
            await runQuery(newMessages);
        }, [messages, runQuery]);

        return (
          <div className="flex flex-col h-[100dvh] bg-slate-100 font-sans md:max-w-4xl md:mx-auto md:my-8 md:h-auto md:max-h-[calc(100%-4rem)] md:rounded-2xl md:shadow-2xl md:overflow-hidden">
            <Header language={language} onLanguageChange={setLanguage} responseLength={responseLength} onResponseLengthChange={setResponseLength} />
            <main className="flex-1 w-full max-w-4xl mx-auto overflow-y-auto custom-scrollbar p-4 min-h-0">
                <ChatWindow messages={messages} onEditMessage={handleEditMessage} />
            </main>
            {error && (
              <div className="w-full max-w-4xl mx-auto p-3 my-2 text-center text-red-700 bg-red-100 border border-red-300 rounded-lg flex-shrink-0">
                <p className="text-sm">{error}</p>
              </div>
            )}
            <div className="w-full max-w-4xl mx-auto p-2 bg-white/80 backdrop-blur-lg border-t border-slate-200/60 flex-shrink-0">
              <ChatInput onSendMessage={handleSendMessage} isLoading={isLoading || !ai} />
            </div>
          </div>
        );
      };

      // --- RENDER ---
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }
      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>
